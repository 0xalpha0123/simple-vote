<html>
<head>

  <script src="./solana-web3.js/lib/index.iife.js"></script>   

  <script>

    const url = 'http://34.64.164.198:8899'

    const contractAddrPK = new solanaWeb3.PublicKey('HPX9CUjj6QpH4eEF5S2UQdrVdjBMErnZeJii2QpF7grj')
    const contractDataPK = new solanaWeb3.PublicKey('6aKHW6jcFhV6yAr9ydZoTsYKHDN5qhbsRaz5E9SsZapQ')

    const seed = 'checkvote'

    const WALLET = 'votedemowalletsk'

    var connection
    var account

    function skStringToAccount(skString) {
      return new solanaWeb3.Account( Uint8Array.from(skString.split(',')) )
    }

    function createCookie(name,value,days) {
      if (days) {
        var date = new Date();
        date.setTime(date.getTime()+(days*24*60*60*1000));
        var expires = "; expires="+date.toUTCString();
      }
      else var expires = "";
      document.cookie = name+"="+value+expires+"; path=/";
    }

    function readCookie(name) {
      var nameEQ = name + "=";
      var ca = document.cookie.split(';');
      for(var i=0;i < ca.length;i++) {
          var c = ca[i];
          while (c.charAt(0)==' ') c = c.substring(1,c.length);
          if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length,c.length);
      }
      return null;
    }

    function eraseCookie(name) {
      createCookie(name,"",-1);
    }

    const candidateNames = [ 'GOLEM', 'TRUMP', 'BIDEN' ]

    var alreadyVoted = null 
    var balance = -1 
    var cost = -1
    var newLeader = 0
    var leader = -1

    async function update() {

      balance = await connection.getBalance(account.publicKey)
      const displayBal = balance + " lamports (" + balance/solanaWeb3.LAMPORTS_PER_SOL + " Sol)"
      document.getElementById('balance').innerHTML = displayBal

      const checkAccountPubkey = await solanaWeb3.PublicKey.createWithSeed(account.publicKey, seed, contractAddrPK)
      alreadyVoted = await connection.getAccountInfo(checkAccountPubkey)

      if ( alreadyVoted ) {
        const votedFor = (new Uint32Array(alreadyVoted.data.buffer))[0]
        if ( votedFor > 0 ) {
          document.getElementById('voterStatus').innerHTML = "<div class='status'>You voted for: "+ candidateNames[ votedFor ] +"</div>"
        } else {
          // for a brief moment the account will exist at zero...
          document.getElementById('voterStatus').innerHTML = "<div class='status'>Vote submitted to Network</div>"
        }
      } else { 
        if (balance===0) {
          document.getElementById('voterStatus').innerHTML = "<div class='err'>^ Deposit Funds To Vote ^</div>"
        }
        if (balance>cost && cost>0) {
          document.getElementById('voterStatus').innerHTML = "<div class='status'>Ready to Vote</div>"
        }
        if (balance>0 && balance<cost && cost>0) {
          document.getElementById('voterStatus').innerHTML = "<div class='err'>More funds required</div>"
        }
      }

      // Vote counts

      const accountInfo = await connection.getAccountInfo(contractDataPK)
      let dataAsU32 = new Uint32Array(accountInfo.data.buffer)
      let count1 = dataAsU32[0] 
      let count2 = dataAsU32[1] 

      document.getElementById('count1').innerHTML = count1
      document.getElementById('count2').innerHTML = count2

      if ( count1 > count2 ) { 
        newLeader = 1 
      } else if ( count2 > count1 ) { 
        newLeader = 2 
      } else {
        newLeader = 0
      }

      if ( leader !== newLeader ) {
        leader = newLeader
        if ( leader === 0 ) {
          document.getElementById('fuhrer').innerHTML = 
              "<img class='w3-padding w3-circle' src='GOLEM.jpg' alt='EVEN STEVENS' style='text-align: center; border-style:solid; border-width:1px; border-color:#111111ff; margin-top:10px; height:100%;'>"
        }
        if ( leader === 1 ) {
          document.getElementById('fuhrer').innerHTML = 
              "<img class='w3-padding w3-circle' src='TRUMP_FTW.jpg' alt='ORANGE GOD RISING' style='text-align: center; border-style:solid; border-width:1px; border-color:#111111ff; margin-top:10px; height:100%;'>"
        }
        if ( leader === 2 ) {
          document.getElementById('fuhrer').innerHTML = 
              "<img class='w3-padding w3-circle' src='BIDEN_FTW.jpg' alt='NO MALARKEY' style='text-align: center; border-style:solid; border-width:1px; border-color:#111111ff; margin-top:10px; height:100%;'>"
        }
      }
      console.log("update complete")
      setTimeout(update, 3000) 
    }

    async function pageload() {

      // User wallet
 
      if ( ! readCookie(WALLET) ) {
        const account = new solanaWeb3.Account()
        createCookie(WALLET,account.secretKey)
      }
    
      account = skStringToAccount(readCookie(WALLET))
      const address = account.publicKey.toString()
      document.getElementById('address').innerHTML = address

      connection = await new solanaWeb3.Connection(url, 'recent')


      // Cost of a vote
  
      const rentExemption = await connection.getMinimumBalanceForRentExemption(4)
      const voteCost = 2 * 5000 // the two signatures
      cost = rentExemption + voteCost
      const displayCost = "(democracy costs "+ cost +" lamports, ~"+ cost/solanaWeb3.LAMPORTS_PER_SOL +" Sol)"
      document.getElementById('voterInvite').innerHTML = "<div class='status'>Please Vote " + displayCost + "</div>"

      // read blockchain and update

      update()

    }

    async function sendAndConfirmTransaction( notify, title, connection, transaction, ...signers) {
      const when = Date.now()

      const signature = await solanaWeb3.sendAndConfirmTransaction(
        connection,
        transaction,
        signers,
        {
          confirmations: 1,
          skipPreflight: true,
        },
      );

      const body = {
        time: new Date(when).toString(),
        signature,
        instructions: transaction.instructions.map(i => {
          return {
            keys: i.keys.map(keyObj => keyObj.pubkey.toBase58()),
            programId: i.programId.toBase58(),
            data: '0x' + i.data.toString('hex'),
          };
        }),
      };

      notify(title, body);
    }

    async function vote(candidate) {

      if ( cost > await connection.getBalance(account.publicKey)) {
        alert("Not enough funds bro, time to get a job?") 
        return
      }

      const checkAccountPubkey = await solanaWeb3.PublicKey.createWithSeed(account.publicKey, seed, contractAddrPK)
      alreadyVoted = await connection.getAccountInfo(checkAccountPubkey)

      if ( alreadyVoted ) {
        const votedFor = (new Uint32Array(alreadyVoted.data.buffer))[0]
        if ( votedFor > 0 ) {
          alert("My dude, you already voted for "+candidateNames[ votedFor ]+", there is no double voting on the blockchain!")
        } 
      }

      // make check account

      const rentExemption = await connection.getMinimumBalanceForRentExemption(4);
      const checkAccountPK = await solanaWeb3.PublicKey.createWithSeed(account.publicKey, seed, contractAddrPK)
      let params = {
        fromPubkey: account.publicKey,  
        lamports: rentExemption,      
        space: 4,                     
        basePubkey: account.publicKey,  
        seed,                          
        programId: contractAddrPK,       
        newAccountPubkey: checkAccountPK,
      }

      const createTransaction = solanaWeb3.SystemProgram.createAccountWithSeed( params )

      let notify = function(receipt) { console.log("Create check-account receipt:",receipt) }

      try {
        await sendAndConfirmTransaction(
          notify,
          'createAccountWithSeed',
          connection,
          createTransaction,
          account,  
        )
      } catch (err) {
        document.getElementById('voterStatus').innerHTML = "<div class='err'>Your vote totally failed dude</div>"
        console.log(err)
        return
      } 

      console.log("User's check account was created at",checkAccountPK.toString())

      // call contract

      const instruction_data = new Uint8Array([candidate])

      const instruction = new solanaWeb3.TransactionInstruction({
      keys: [
               {pubkey: contractDataPK, isSigner: false, isWritable: true},             
               {pubkey: checkAccountPK, isSigner: false, isWritable: true},            
               {pubkey: solanaWeb3.SYSVAR_RENT_PUBKEY, isSigner: false, isWritable: false}
               {pubkey: account.publicKey, isSigner: true, isWritable: false}         
            ],
      programId: contractAddrPK,
      data: instruction_data,
    })

    notify = function(receipt) { console.log("Vote transaction receipt:",receipt) }

    try { 
      await sendAndConfirmTransaction(
        notify,
        'vote',
        connection,
        new solanaWeb3.Transaction().add(instruction),
        account,
      )
    } catch (err) {
        document.getElementById('voterStatus').innerHTML = "<div class='err'>Oh noes, disaster!</div>"
        console.log(err)
        return
    }
  }

  </script>

  <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
  <link href="https://fonts.googleapis.com/css2?family=Viaoda+Libre&display=swap" rel="stylesheet">

  <style>

  .frame {
    min-width: 600px;
    border-style: solid;
    border-width: 0px;
  }

  .top {
    background-color: #0d76bdff;
    width: 100%;
    height: 32%;
  }

  .middle {
    background-color: #ffffffff;
    width: 100%;
    height: 40%;
  }

  .bottom {
    background-color: #ed1c23ff;
    width: 100%;
    height: 25%;
  }

  .bigtext {
    font-size: 36px;
    font-family: 'Viaoda Libre', cursive; 
    font-weight: bold;
    color: #111111ff;
    border-top: 5px;
    border-bottom: 5px;
    text-align: center;
  }

  .bigtextreg {
    font-size: 36px;
    font-family: 'Viaoda Libre', cursive; 
    color: #111111ff;
    border-top: 5px;
    border-bottom: 5px;
    text-align: center;
  }

  .status {
    font-size: 26px;
    font-family: 'Viaoda Libre', cursive; 
    color: #111111ff;
    border-top: 5px;
    border-bottom: 5px;
    text-align: center;
  }

  .err {
    font-size: 26px;
    font-family: 'Viaoda Libre', cursive; 
    font-weight: bold;
    color: #8B0000ff;
    border-top: 5px;
    border-bottom: 5px;
    text-align: center;
  }

  table {
    margin-bottom:10px; 
    margin-left:auto; 
    margin-right:auto;
    text-align: center;
    border-collapse: collapse;
  }

  table, td, th {
    font-size: 24;
    font-family: 'Viaoda Libre', cursive; 
    border: 1px solid #111111ff;
  }

  #voterInvite {
    margin-bottom: 10px;
    margin-left: auto;
    margin-right: auto;
    height: 45px;
  }  

  #voterStatus {
    padding-top: 10;
    margin-left: auto;
    margin-right: auto;
    height: 35px;
  }  

  .utilButtons {
    background-color: #00000022;
    width: 160px; 
    position:absolute;
    top: 10px;
    right: 10px;
    display: inline-block;
    vertical-align: top;
    padding-bottom: 5px;
  }

  .utilButton {
    width: 150px;
    margin-top: 5px;
    margin-left: 5px;
    border-radius: 4px;
    background-color: #0d76bdff;
    color: #222222ff;
    border: 2px solid #222222ff;
    transition-duration: 0.4s;
  }
  .utilButton:hover {
    background-color: #222222ff;
    color: white;
  }

  .mainButton {
    height: 50px;
    width: 150px;
    margin-top: 5px;
    margin-left: 5px;
    border-radius: 4px;
    background-color: #0d76bdaa;
    color: #222222ff;
    border: 2px solid #222222ff;
    transition-duration: 0.4s;
  }
  .mainButton:hover {
    background-color: #ed1c23ff; 
    color: white;
  }

  .column {
    float: left;
    width: 33.33%;
    height: 100%;
    padding: 10px;
    text-align: center;
  }

  /* Clear floats after the columns */
  .row:after {
    content: "";
    display: table;
    clear: both;
  }

  .vctext {
    font-size: 40px;
    font-family: 'Viaoda Libre', cursive; 
    font-weight: bold;
    color: #111111ff;
    border-top: 5px;
    border-bottom: 5px;
    text-align: center;
  }

  .smalltext {
    font-size: 18px;
    font-family: 'Viaoda Libre', cursive; 
    color: #111111ff;
    border-top: 5px;
    border-bottom: 5px;
    text-align: center;
  }

  .footer {
    font-size: 16px;
    font-family: 'Viaoda Libre', cursive; 
    color: #111111ff;
    border-top: 5px;
    border-bottom: 5px;
    text-align: center;
  }

  </style>

</head>
<body style="background-color:black" onload="pageload()">

  <div class='frame'>


  <!-- wallet address, funds, status -->

  <div class='top'>

    <div class='bigtext' style="padding-top:10px">SOLANA ELECTION 2020</div>

    <div id="voterInvite"> </div>

    <table style="width: 60%">

      <colgroup>
        <col span="1" style="width: 20%;">
        <col span="1" style="width: 40%;">
      </colgroup>

      <tr>
        <td>Wallet Address</td>
        <td><div id="address"> </div></td>
      </tr>
      <tr>
        <td>Wallet Balance</td>
        <td><div id="balance"> </div></td>
      </tr>
    </table>

    <div id="voterStatus"> </div>

    <div class='utilButtons'>
    <button class='utilButton' onclick="eraseCookie(WALLET); location.reload();">Destroy Wallet</button>
    <button class='utilButton' onclick="alert('['+readCookie(WALLET)+']'); this.blur();">Show Secret Key</button>
    </div>

  </div>


  <!-- vote count, images, vote buttons -->

  <div class='middle'>

    <div class="row">
      <div class="column" style="width:25%">
        <img src="TRUMP.jpg" alt="Trump" style="height:100%; ">
      </div>
      <div class="column" style="width:50%">
        <div class='bigtextreg'>VOTE COUNT</div>

          <div class="row">
            <div class="column" style="width:25%">
              <div class='vctext'>TRUMP</div>
              <div class="vctext" id='count1'>-</div>
              <button class="mainButton" style="margin-top:20%" onclick="vote(1);">VOTE TRUMP</button>
            </div>
            <div class="column" style="width:50%; margin-top:15px;">
              <div class='smalltext'>CURRENTLY ASCENDANT</div>
                <div id="fuhrer">
                  <img class="w3-padding w3-circle" alt="LEADER" src="NOTHING.jpg" alt="Who Will It Be Now?" 
                    style="text-align: center; border-style:solid; border-width:1px; border-color:#111111ff; margin-top:10px; height:100%;">
                </div>
            </div>
            <div class="column" style="width:25%">
              <div class='vctext'>BIDEN</div>
              <div class="vctext" id='count2'>-</div>
              <button class="mainButton" style="margin-top:20%" onclick="vote(2);">VOTE BIDEN</button>
            </div>
          </div>

      </div>
      <div class="column" style="width:25%">
        <img src="BIDEN.jpg" alt="Biden" style="height:100%; ">
      </div>
    </div>

  </div>

  <!-- credits, links etc -->

  <div class='bottom'>
      <div class="row" style="height:50%">
      </div>
      <div class="row" style="text-align:center; height:35%">
        <div class='smalltext'>This is part of a tutorial on how to write Smart Contracts for the Solana Blackchain</div>
        <a href="https://mcf.rocks">
          <div class='smalltext'>This tutorial was put together by MCF, if you are a Hodler, please consider delegating to our Validator on the Solana Network</div>
        </a>
      </div>
  </div>

</body>
</html>



